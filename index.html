const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby0tuLXEL_PdlM5JCtMtPpiImzbTuPzpTYna59aqbqIUojci-OVKLzIMBVEtk1DsPP5/exec";

async function load() {
  const loader = document.getElementById('loader');
  const feed = document.getElementById('feed');
  loader.classList.remove('hidden');
  
  try {
    const res = await fetch(SCRIPT_URL);
    const data = await res.json();
    
    feed.innerHTML = data.map(p => {
      // Create HTML for comments
      const commentHtml = p.comments.map(c => `
        <div style="background: #f2f3f5; padding: 5px 8px; margin-top: 4px; border-radius: 4px; font-size: 12px;">
          <b style="color: #365899;">${c.user}</b> ${c.text}
        </div>
      `).join('');

      return `
      <div class="card">
        <div class="post-user">${p.user}</div>
        <div class="post-date">${new Date(p.timestamp).toLocaleString()}</div>
        <div class="post-msg">${p.message}</div>
        ${p.image ? `<img src="${p.image}" class="post-img">` : ""}
        
        <div style="border-top: 1px solid #e9ebee; margin-top: 10px; padding-top: 8px;">
           <span onclick="handleAction('like', ${p.rowIndex})" style="color: #365899; font-size: 12px; font-weight: bold; cursor: pointer;">Like</span> 
           <span style="color: #90949c; font-size: 12px;"> â€¢ ${p.likes || 0} people like this.</span>
        </div>

        <div id="comments-${p.rowIndex}" style="margin-top: 8px;">
          ${commentHtml}
        </div>

        <div style="margin-top: 8px; display: flex; gap: 5px;">
          <input type="text" id="input-${p.rowIndex}" placeholder="Write a comment..." style="margin-bottom: 0; font-size: 11px; padding: 4px;">
          <button class="btn" onclick="handleAction('comment', ${p.rowIndex})" style="padding: 2px 8px;">Post</button>
        </div>
      </div>
    `}).join('');
  } catch (e) {
    feed.innerHTML = "<div class='card'>Connection failed.</div>";
  } finally {
    loader.classList.add('hidden');
  }
}

async function handleAction(action, rowIndex) {
  const username = document.getElementById('user').value || "Anonymous";
  const payload = { action, rowIndex, username };

  if (action === 'comment') {
    const commentInput = document.getElementById(`input-${rowIndex}`);
    if (!commentInput.value) return;
    payload.text = commentInput.value;
    commentInput.value = "";
  }

  // Show loader and optimistically update or just wait for reload
  document.getElementById('loader').classList.remove('hidden');

  try {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    load(); // Refresh feed to show new like/comment
  } catch (err) {
    alert("Error updating post.");
    document.getElementById('loader').classList.add('hidden');
  }
}

function upload() {
  const u = document.getElementById('user').value;
  const m = document.getElementById('msg').value;
  const f = document.getElementById('file').files[0];
  const btn = document.getElementById('btn');
  
  if(!u || !m) return alert("Please enter your name and a message.");
  
  btn.disabled = true;
  document.getElementById('loader').classList.remove('hidden');

  const reader = new FileReader();
  reader.onload = async (e) => {
    // UPDATED PAYLOAD: added "action: 'post'"
    const payload = {
      action: "post",
      username: u,
      message: m,
      image: f ? e.target.result : ""
    };
    
    try {
      await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      });
      document.getElementById('msg').value = "";
      document.getElementById('file').value = "";
      load();
    } catch (err) {
      alert("Could not post.");
    } finally {
      btn.disabled = false;
    }
  };

  if(f) {
    reader.readAsDataURL(f); 
  } else {
    reader.onload(); 
  }
}

window.onload = load;
