// MAKE SURE THIS IS YOUR LATEST DEPLOYMENT URL
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby0tuLXEL_PdlM5JCtMtPpiImzbTuPzpTYna59aqbqIUojci-OVKLzIMBVEtk1DsPP5/exec";

async function load() {
  const feed = document.getElementById('feed');
  const loader = document.getElementById('loader');
  
  loader.classList.remove('hidden');
  
  try {
    const res = await fetch(SCRIPT_URL);
    const data = await res.json();
    
    // Check if data is actually an array
    if (!Array.isArray(data)) {
      feed.innerHTML = "<div class='card'>No posts found yet! Be the first to post.</div>";
      return;
    }

    feed.innerHTML = data.map(p => {
      // Ensure comments are handled correctly even if empty
      let comments = [];
      if (p.comments && Array.isArray(p.comments)) {
        comments = p.comments;
      }

      const commentHtml = comments.map(c => `
        <div class="comment-box">
          <b style="color: #365899;">${c.user || 'Anon'}:</b> ${c.text || ''}
        </div>
      `).join('');

      return `
      <div class="card">
        <div class="post-user">${p.user || 'Unknown User'}</div>
        <div class="post-date">${p.timestamp ? new Date(p.timestamp).toLocaleString() : 'Recently'}</div>
        <div class="post-msg">${p.message || ''}</div>
        ${p.image ? `<img src="${p.image}" class="post-img">` : ""}
        
        <div style="border-top: 1px solid #e9ebee; margin-top: 10px; padding-top: 8px;">
           <span onclick="handleAction('like', ${p.rowIndex})" style="color: #365899; font-size: 12px; font-weight: bold; cursor: pointer;">Like</span> 
           <span style="color: #90949c; font-size: 12px;"> â€¢ ${p.likes || 0} likes</span>
        </div>

        <div id="comments-${p.rowIndex}">${commentHtml}</div>

        <div style="margin-top: 8px; display: flex; gap: 5px;">
          <input type="text" id="input-${p.rowIndex}" placeholder="Write a comment..." style="margin-bottom:0; height:25px; flex-grow:1;">
          <button class="btn" onclick="handleAction('comment', ${p.rowIndex})">Reply</button>
        </div>
      </div>`;
    }).join('');
  } catch (e) {
    console.error(e);
    feed.innerHTML = "<div class='card'>Error loading feed. Please check your Script URL and Deployment.</div>";
  } finally {
    loader.classList.add('hidden');
  }
}

async function handleAction(action, rowIndex) {
  const userInput = document.getElementById('user').value.trim();
  const user = userInput || "Anonymous";
  let payload = { action, rowIndex, username: user };

  if (action === 'comment') {
    const inp = document.getElementById(`input-${rowIndex}`);
    if (!inp.value.trim()) return;
    payload.text = inp.value;
    inp.value = "";
  }

  document.getElementById('loader').classList.remove('hidden');
  
  try {
    await fetch(SCRIPT_URL, { 
      method: 'POST', 
      mode: 'no-cors', // Helps with some browser security restrictions
      body: JSON.stringify(payload) 
    });
    // Wait a moment for Google to update before reloading
    setTimeout(load, 1000); 
  } catch (err) {
    alert("Update failed. Try again.");
    document.getElementById('loader').classList.add('hidden');
  }
}

function upload() {
  const u = document.getElementById('user').value.trim();
  const m = document.getElementById('msg').value.trim();
  const f = document.getElementById('file').files[0];
  const btn = document.getElementById('btn');

  if(!u || !m) return alert("Please enter your name and a message.");

  btn.disabled = true;
  document.getElementById('loader').classList.remove('hidden');

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({ 
          action: "post", 
          username: u, 
          message: m, 
          image: f ? e.target.result : "" 
        })
      });
      document.getElementById('msg').value = "";
      document.getElementById('file').value = "";
      setTimeout(load, 1000);
    } catch (err) {
      alert("Post failed.");
    } finally {
      btn.disabled = false;
    }
  };

  if(f) {
    reader.readAsDataURL(f); 
  } else {
    reader.onload(); 
  }
}

window.onload = load;
