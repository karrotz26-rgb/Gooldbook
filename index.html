<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Gooldbook</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "4577a6bd-cd70-41d2-bf78-aba5f6211064",
          safari_web_id: "web.onesignal.auto.35c3b21f-3634-4ed2-bd52-fd09e2637415",
          notifyButton: { enable: true, displayPredicate: null },
        });
        OneSignal.Notifications.requestPermission();
      });
    </script>
    <style>
        body { background-color: #e9ebee; color: #1c1e21; font-family: Helvetica, Arial, sans-serif; margin: 0; padding-bottom: 50px; scroll-behavior: smooth; }
        .nav { background-color: #3b5998; color: white; padding: 12px; text-align: center; font-weight: bold; font-size: 22px; position: sticky; top: 0; z-index: 2000; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .container { max-width: 850px; margin: 20px auto; display: flex; gap: 20px; padding: 0 10px; align-items: flex-start; }
        .sidebar { width: 250px; position: sticky; top: 70px; max-height: calc(100vh - 90px); overflow-y: auto; }
        .main-feed { flex-grow: 1; max-width: 500px; min-width: 300px; }
        .sticky-composer { position: sticky; top: 70px; z-index: 1000; background: #e9ebee; padding-bottom: 10px; }
        .card { background: white; border: 1px solid #dddfe2; border-radius: 3px; padding: 12px; margin-bottom: 15px; position: relative; }
        .sync-status { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-pending { background-color: #ffc107; animation: pulse 1s infinite; }
        .status-success { background-color: #4caf50; }
        .status-error { background-color: #f44336; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        input, textarea { width: 100%; border: 1px solid #dddfe2; padding: 8px; margin-bottom: 8px; border-radius: 3px; box-sizing: border-box; font-size: 13px; }
        .btn { background-color: #4267b2; color: white; border: none; padding: 8px 16px; font-weight: bold; cursor: pointer; border-radius: 2px; }
        .post-user { color: #365899; font-weight: bold; font-size: 14px; }
        .post-img { width: calc(100% + 24px); margin: 10px -12px; display: block; max-height: 450px; object-fit: cover; }
        .action-bar { border-top: 1px solid #e9ebee; padding-top: 8px; margin-top: 10px; font-size: 13px; font-weight: bold; }
        .comment-box { background: #f2f3f5; border-radius: 8px; padding: 8px 12px; margin-top: 5px; font-size: 12px; }
        .trending-item { margin-bottom: 8px; font-size: 12px; cursor: pointer; color: #365899; }
        .refresh-btn { background: #f5f6f7; border: 1px solid #ccd0d5; padding: 5px 10px; cursor: pointer; font-size: 12px; width: 100%; margin-top: 10px; }
        .hidden { display: none; }
        @media (max-width: 600px) { .container { flex-direction: column; } .sidebar { width: 100%; position: static; } }
    </style>
</head>
<body>

<div class="nav">theGooldbook</div>
<div class="container">
    <div class="sidebar">
        <div class="card">
            <b>üîç Search</b>
            <input type="text" id="searchBar" placeholder="Search posts..." oninput="handleSearch()">
        </div>
        <div class="card"><b>üëç Trending</b><div id="trending-list"></div></div>
    </div>

    <div class="main-feed">
        <div class="sticky-composer">
            <div class="card">
                <input type="text" id="user" placeholder="Your Name">
                <textarea id="msg" placeholder="What's on your mind?" rows="2"></textarea>
                <div style="display: flex; justify-content: space-between;">
                    <input type="file" id="file" accept="image/*" style="width: auto; border:none; font-size:10px;">
                    <button class="btn" onclick="upload()">Post</button>
                </div>
                <button class="refresh-btn" onclick="manualRefresh()">üîÑ Refresh Feed</button>
            </div>
        </div>
        <div id="feed"></div>
        <button id="loadMoreBtn" class="btn hidden" style="width:100%; background:#fff; color:#4b4f56; border:1px solid #ddd;" onclick="renderMore()">Load More...</button>
    </div>
</div>

<script>
    // 1. UPDATE THIS URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwTbcCTRNUoRWVudyJz3kHwU5BudB_f1Kw0XLGvX1uQuocLEHyjY1wZaknzVefJ11_k/exec";
    const CACHE_KEY = "gooldbook_cache";
    let allPosts = [], displayedCount = 0;

    window.onload = () => {
        const saved = localStorage.getItem('gb_user');
        if (saved) document.getElementById('user').value = saved;
        loadFromCache();
        loadWithRetry(3);
    };

    function loadFromCache() {
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) { 
            allPosts = JSON.parse(cached); 
            renderMore(true); 
            renderSidebars();
        }
    }

    async function loadWithRetry(retries) {
        for (let i = 0; i < retries; i++) {
            try {
                const res = await fetch(SCRIPT_URL);
                allPosts = await res.json();
                localStorage.setItem(CACHE_KEY, JSON.stringify(allPosts));
                renderMore(true);
                renderSidebars();
                return;
            } catch (e) { await new Promise(r => setTimeout(r, 2000)); }
        }
    }

    function renderMore(reset = false) {
        const feed = document.getElementById('feed');
        if (reset) { displayedCount = 0; feed.innerHTML = ""; }
        const chunk = allPosts.slice(displayedCount, displayedCount + 10);
        const user = document.getElementById('user').value.trim();
        const html = chunk.map(p => generatePostHtml(p, user)).join('');
        feed.insertAdjacentHTML('beforeend', html);
        displayedCount += 10;
        document.getElementById('loadMoreBtn').classList.toggle('hidden', displayedCount >= allPosts.length);
    }

    function generatePostHtml(p, user) {
        const likes = p.likes || [];
        const comments = p.comments || [];
        const hasLiked = likes.includes(user);
        return `
            <div class="card" id="post-${p.rowIndex}">
                <div style="display:flex; justify-content:space-between;">
                    <span class="post-user">${p.user}</span>
                    <div id="status-${p.rowIndex}" class="sync-status status-success"></div>
                </div>
                <div style="font-size:11px; color:#90949c;">${new Date(p.timestamp).toLocaleString()}</div>
                <div style="margin:10px 0;">${p.message}</div>
                ${p.image ? `<img src="${p.image}" class="post-img">` : ''}
                <div class="action-bar">
                    <span style="cursor:pointer; color:#365899;" onclick="handleAction('like', ${p.rowIndex})">${hasLiked ? '‚ù§Ô∏è Unlike' : 'üëç Like'}</span>
                    <span style="color:#90949c;"> ‚Ä¢ ${likes.length} likes</span>
                </div>
                <div id="comments-${p.rowIndex}">${comments.map(c => `<div class="comment-box"><b>${c.user}</b>: ${c.text}</div>`).join('')}</div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <input type="text" id="reply-${p.rowIndex}" placeholder="Write a comment..." style="margin:0; padding:5px; font-size:12px;">
                    <button class="btn" style="padding:4px 10px; font-size:11px;" onclick="handleAction('comment', ${p.rowIndex})">Reply</button>
                </div>
            </div>`;
    }

    async function handleAction(type, rowIndex) {
        const user = document.getElementById('user').value.trim();
        if (!user) return alert("Name required!");
        const post = allPosts.find(p => p.rowIndex === rowIndex);
        if (!post) return;

        const payload = { action: type, rowIndex: rowIndex, username: user };
        if (type === 'like') {
            const idx = post.likes.indexOf(user);
            if (idx === -1) post.likes.push(user); else post.likes.splice(idx, 1);
        } else {
            const inp = document.getElementById(`reply-${rowIndex}`);
            if (!inp.value.trim()) return;
            payload.text = inp.value;
            post.comments.push({ user: user, text: inp.value });
            inp.value = "";
        }

        const postCard = document.getElementById(`post-${rowIndex}`);
        if (postCard) {
            postCard.innerHTML = generatePostHtml(post, user);
            document.getElementById(`status-${rowIndex}`).className = "sync-status status-pending";
        }

        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            document.getElementById(`status-${rowIndex}`).className = "sync-status status-success";
            renderSidebars();
        } catch (e) { document.getElementById(`status-${rowIndex}`).className = "sync-status status-error"; }
    }

    function upload() {
        const u = document.getElementById('user').value.trim(), m = document.getElementById('msg').value.trim(), f = document.getElementById('file').files[0];
        if (!u || !m) return alert("Fill fields!");
        const reader = new FileReader();
        reader.onload = async (e) => {
            const img = f ? e.target.result : "";
            allPosts.unshift({ user: u, message: m, image: img, likes: [], comments: [], timestamp: new Date(), rowIndex: Date.now() });
            renderMore(true);
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'post', username: u, message: m, image: img }) });
            setTimeout(manualRefresh, 4000);
        };
        if (f) reader.readAsDataURL(f); else reader.onload();
    }

    function renderSidebars() {
        const trending = [...allPosts].sort((a,b) => b.likes.length - a.likes.length).slice(0,5);
        document.getElementById('trending-list').innerHTML = trending.map(p => `
            <div class="trending-item" onclick="window.scrollTo(0, document.getElementById('post-${p.rowIndex}').offsetTop - 100)">
                <b>${p.likes.length} Likes</b>: ${p.message.substring(0,20)}...
            </div>`).join('');
    }

    function handleSearch() {
        const q = document.getElementById('searchBar').value.toLowerCase();
        const filtered = allPosts.filter(p => p.message.toLowerCase().includes(q) || p.user.toLowerCase().includes(q));
        const user = document.getElementById('user').value.trim();
        document.getElementById('feed').innerHTML = filtered.map(p => generatePostHtml(p, user)).join('');
    }

    function manualRefresh() { loadWithRetry(3); }
</script>
</body>
</html>
