<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Gooldbook</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "4577a6bd-cd70-41d2-bf78-aba5f6211064",
          safari_web_id: "web.onesignal.auto.35c3b21f-3634-4ed2-bd52-fd09e2637415",
          notifyButton: { enable: true },
        });
      });
    </script>
    <style>
        body { background-color: #e9ebee; font-family: Arial, sans-serif; margin: 0; padding-bottom: 50px; overflow-x: hidden; }
        .nav { background: #3b5998; color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 1000; }
        
        #pull-indicator { 
            height: 0; 
            overflow: hidden; 
            background: #dfe3ee; 
            text-align: center; 
            line-height: 50px; 
            font-size: 14px; 
            color: #3b5998; 
            font-weight: bold;
            transition: height 0.1s ease;
        }

        .container { max-width: 900px; margin: auto; display: flex; gap: 20px; padding: 10px; align-items: flex-start; }
        .sidebar { width: 280px; position: sticky; top: 70px; }
        .main-feed { flex-grow: 1; max-width: 550px; }

        .card { background: white; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 4px; position: relative; }
        .sidebar-card { background: white; border: 1px solid #ddd; padding: 12px; margin-bottom: 10px; border-radius: 4px; font-size: 13px; }
        
        .user { color: #365899; font-weight: bold; }
        .post-img { width: 100%; margin-top: 10px; border-radius: 4px; }
        .btn { background: #4267b2; color: white; border: none; padding: 8px 12px; cursor: pointer; font-weight: bold; border-radius: 2px; }
        
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; float: right; }
        .dot-green { background: #4caf50; }
        .dot-yellow { background: #ffc107; }
        .dot-error { background: #f44336; }
        
        .liked-by { font-size: 12px; color: #606770; margin-top: 5px; cursor: pointer; }
        .liked-by:hover { text-decoration: underline; }

        .comment-box { background: #f2f3f5; border-radius: 8px; padding: 8px; margin-top: 5px; font-size: 13px; }
        .trending-item { margin-bottom: 8px; cursor: pointer; color: #365899; display: block; text-decoration: none; border-bottom: 1px solid #f0f0f0; padding-bottom: 4px; }

        input, textarea { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }

        @media (max-width: 700px) {
            .container { flex-direction: column; align-items: stretch; }
            .sidebar { width: 100%; position: static; }
        }
    </style>
</head>
<body id="body-content">

<div id="pull-indicator">üîΩ Pull to refresh</div>
<div class="nav">theGooldbook</div>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-card">
            <b>üîç Search</b>
            <input type="text" id="searchBar" placeholder="Filter posts..." oninput="render()">
        </div>
        <div class="sidebar-card"><b>üî• Trending</b><div id="top-liked"></div></div>
    </div>

    <div class="main-feed">
        <div class="card">
            <input type="text" id="user" placeholder="Your Name">
            <textarea id="msg" placeholder="What's on your mind?" rows="2"></textarea>
            <button class="btn" style="width:100%" onclick="upload()">Post</button>
        </div>
        <div id="feed">Loading feed...</div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbya9m4KXIg2m73ryT3dEEEauRra5HskeL96siTWCCqHL9QuKclVx1Cug-JHvp8Ir_f3/exec";
    let allPosts = [];
    
    // --- PULL TO REFRESH LOGIC ---
    let startY = 0;
    const pullThreshold = 80;
    const indicator = document.getElementById('pull-indicator');

    window.addEventListener('touchstart', (e) => {
        if (window.scrollY === 0) startY = e.touches[0].pageY;
    }, {passive: true});

    window.addEventListener('touchmove', (e) => {
        const y = e.touches[0].pageY;
        const pullDistance = y - startY;
        if (window.scrollY === 0 && pullDistance > 0) {
            indicator.style.height = Math.min(pullDistance, pullThreshold) + 'px';
            indicator.innerText = pullDistance > pullThreshold ? "üöÄ Release to Refresh" : "üîΩ Pull to refresh";
        }
    }, {passive: true});

    window.addEventListener('touchend', () => {
        if (parseInt(indicator.style.height) >= pullThreshold) {
            indicator.innerText = "üîÑ Loading...";
            loadFeed();
        }
        indicator.style.height = '0px';
    });

    // --- CORE APP LOGIC ---
    async function loadFeed() {
        try {
            const res = await fetch(SCRIPT_URL);
            allPosts = await res.json();
            localStorage.setItem('gooldbook_cache', JSON.stringify(allPosts));
            render();
        } catch (e) { console.error(e); }
    }

    function render() {
        const user = document.getElementById('user').value.trim();
        const search = document.getElementById('searchBar').value.toLowerCase();
        const filtered = allPosts.filter(p => p.message.toLowerCase().includes(search) || p.user.toLowerCase().includes(search));
        
        document.getElementById('feed').innerHTML = filtered.map(p => {
            const likes = p.likes || [];
            
            // Logic to show names who liked
            let likedText = "";
            if (likes.length > 0) {
                if (likes.length === 1) likedText = `Liked by ${likes[0]}`;
                else if (likes.length === 2) likedText = `Liked by ${likes[0]} and ${likes[1]}`;
                else likedText = `Liked by ${likes[0]} and ${likes.length - 1} others`;
            }

            return `
                <div class="card" id="post-${p.rowIndex}">
                    <div style="display:flex; justify-content:space-between;">
                        <span class="user">${p.user}</span>
                        <div class="sync-dot dot-green"></div>
                    </div>
                    <p>${p.message}</p>
                    <div style="border-top:1px solid #eee; padding-top:10px; margin-top:10px; font-size:13px;">
                        <button onclick="handleAction('like', ${p.rowIndex})" style="background:none; border:none; color:#365899; font-weight:bold; cursor:pointer;">
                            ${likes.includes(user) ? '‚ù§Ô∏è Unlike' : 'üëç Like'} (${likes.length})
                        </button>
                        ${user.toLowerCase() === 'admin' ? `<button onclick="handleAction('delete', ${p.rowIndex})" style="color:red; background:none; border:none; cursor:pointer; margin-left:10px;">üóëÔ∏è Delete</button>` : ''}
                        
                        ${likedText ? `<div class="liked-by" onclick="alert('Liked by:\\n${likes.join('\\n')}')">${likedText}</div>` : ''}
                    </div>
                    <div id="comments-${p.rowIndex}">${(p.comments || []).map(c => `<div class="comment-box"><b>${c.user}</b>: ${c.text}</div>`).join('')}</div>
                    <div style="display:flex; margin-top:10px; gap:5px;">
                        <input type="text" id="reply-${p.rowIndex}" placeholder="Comment..." style="margin:0; font-size:12px;">
                        <button class="btn" style="padding:4px 10px; font-size:12px;" onclick="handleAction('comment', ${p.rowIndex})">Reply</button>
                    </div>
                </div>
            `;
        }).join('');
        updateSidebar();
    }

    function updateSidebar() {
        const liked = [...allPosts].sort((a,b) => (b.likes.length || 0) - (a.likes.length || 0)).slice(0, 5);
        document.getElementById('top-liked').innerHTML = liked.map(p => `
            <div class="trending-item" onclick="document.getElementById('post-${p.rowIndex}').scrollIntoView({behavior:'smooth'})">
                <b>${p.likes.length} üëç</b>: ${p.message.substring(0,20)}...
            </div>`).join('');
    }

    async function handleAction(action, rowIndex) {
        const user = document.getElementById('user').value.trim();
        if (!user) return alert("Name required!");

        const post = allPosts.find(p => p.rowIndex === rowIndex);
        const dot = document.querySelector(`#post-${rowIndex} .sync-dot`);
        if (dot) dot.className = "sync-dot dot-yellow";

        let payload = { action, rowIndex, username: user };

        if (action === 'comment') {
            const inp = document.getElementById(`reply-${rowIndex}`);
            if (!inp.value.trim()) return;
            payload.text = inp.value;
            post.comments.push({ user, text: inp.value });
            inp.value = "";
        } else if (action === 'like') {
            const idx = post.likes.indexOf(user);
            if (idx === -1) post.likes.push(user); else post.likes.splice(idx, 1);
        } else if (action === 'delete') {
            if (!confirm("Delete?")) return;
            allPosts = allPosts.filter(p => p.rowIndex !== rowIndex);
        }

        render(); 

        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            if (document.querySelector(`#post-${rowIndex} .sync-dot`)) 
                document.querySelector(`#post-${rowIndex} .sync-dot`).className = "sync-dot dot-green";
        } catch (e) {
            if (document.querySelector(`#post-${rowIndex} .sync-dot`)) 
                document.querySelector(`#post-${rowIndex} .sync-dot`).className = "sync-dot dot-error";
        }
    }

    async function upload() {
        const u = document.getElementById('user').value.trim();
        const m = document.getElementById('msg').value.trim();
        if (!u || !m) return alert("Fill in your name and message!");
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'post', username: u, message: m }) });
        document.getElementById('msg').value = "";
        loadFeed();
    }

    document.getElementById('user').oninput = (e) => localStorage.setItem('gb_user', e.target.value);
    window.onload = () => {
        document.getElementById('user').value = localStorage.getItem('gb_user') || "";
        const cached = localStorage.getItem('gooldbook_cache');
        if (cached) { allPosts = JSON.parse(cached); render(); }
        loadFeed();
    };
</script>
</body>
</html>
